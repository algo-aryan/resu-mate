<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Application Tracker | ResuMate</title>
    <link rel="stylesheet" href="./upload.css" />
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
          <div class="navbar-inner">
            <a href="dashboard.html" class="logo">
              <div class="logo-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor" />
                </svg>
              </div>
              <span class="logo-text">ResuMate</span>
            </a>
            <div class="navbar-right">
              <div class="nav-links">
                <a href="dashboard.html" class="nav-link">Home</a>
                <a href="upload.html" class="nav-link">Internships</a>
                <a href="resume-builder.html" class="nav-link">Resume Builder</a>
                <a href="tracker.html" class="nav-link active">Tracker</a>
                <a href="/interview" class="nav-link">Interview</a>
              </div>
              <div class="nav-divider"></div>
              <div class="profile-section">
                <a href="/profile" class="profile-link">
                  <img src="https://i.pravatar.cc/40" alt="Profile" class="profile-avatar">
                  <span>Profile</span>
                </a>
              </div>
            </div>
          </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="hero">
                <h1>Application Dashboard</h1>
                <p>Stay organized and manage all your tracked internship applications in one convenient place.</p>
            </section>

            <section class="tracker-section">
                <div id="trackedResults">
                    </div>
            </section>
        </div>
    </main>

    <script>
        const userId = localStorage.getItem("userId");

        async function loadTracked() {
            const trackedResults = document.getElementById("trackedResults");
            trackedResults.innerHTML = '<p class="tracker-status-message">Loading your tracked internships...</p>';

            try {
                // Ensure userId exists before fetching
                if (!userId) {
                    trackedResults.innerHTML = '<p class="tracker-status-message error">Could not find user ID. Please log in again.</p>';
                    return;
                }

                const res = await fetch(`https://resumate-ewtu.onrender.com/api/tracked-internships/${userId}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();

                if (!data.length) {
                    trackedResults.innerHTML = '<p class="tracker-status-message">You haven\'t tracked any internships yet.</p>';
                    return;
                }

                trackedResults.innerHTML = ''; // Clear loading message
                data.forEach(job => {
                    const div = document.createElement("div");
                    div.className = "card";

                    const atsScoreValue = job.ats !== null ? parseInt(job.ats) : -1;
                    const atsScoreText = atsScoreValue !== -1 ? `${atsScoreValue}%` : "N/A";
                    let atsClass = 'ats-none';

                    if (atsScoreValue >= 70) {
                        atsClass = 'ats-high';
                        div.classList.add('card-ats-high');
                    } else if (atsScoreValue >= 40) {
                        atsClass = 'ats-medium';
                        div.classList.add('card-ats-medium');
                    } else if (atsScoreValue !== -1) {
                        atsClass = 'ats-low';
                        div.classList.add('card-ats-low');
                    }
                    
                    const trackedDate = new Date(job.trackedAt).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });

                    div.innerHTML = `
                        <div class="card-content">
                            <h4>${job.title}</h4>
                            <p><strong>Company:</strong> ${job.company}</p>
                            <p><strong>ATS Match:</strong> <span class="${atsClass}">${atsScoreText}</span></p>
                            <p><a href="${job.link}" target="_blank" class="card-link">üîó View Internship</a></p>
                            <p class="tracked-date">Tracked on: ${trackedDate}</p>
                        </div>
                        <div class="card-actions">
                             <button onclick="untrackInternship('${job._id}')" class="untrack-btn">‚ùå Untrack</button>
                        </div>
                    `;
                    trackedResults.appendChild(div);
                });
            } catch (error) {
                console.error("Failed to load tracked internships:", error);
                trackedResults.innerHTML = '<p class="tracker-status-message error">Error loading tracked internships. Please try again later.</p>';
            }
        }

        async function untrackInternship(id) {
            const confirmDelete = confirm("Are you sure you want to remove this from your tracker?");
            if (!confirmDelete) return;

            try {
                const res = await fetch(`https://resumate-ewtu.onrender.com/api/untrack-internship/${id}`, {
                    method: "DELETE",
                });

                const data = await res.json();

                if (res.ok) {
                    alert("‚úÖ Internship untracked successfully!");
                    loadTracked(); // Refresh the list
                } else {
                    alert(`‚ùå Failed to untrack internship: ${data.message || "Unknown error"}`);
                }
            } catch (err) {
                console.error("Error while untracking:", err);
                alert("‚ùå Network error while untracking internship.");
            }
        }

        window.onload = loadTracked;
    </script>
</body>
</html>
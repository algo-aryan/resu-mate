<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Internships | ResuMate</title>
  <link rel="stylesheet" href="./upload.css" />
  <script src="https://cdn.lordicon.com/lordicon.js"></script>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-inner">
        <a href="dashboard.html" class="logo">
          <div class="logo-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor" />
            </svg>
          </div>
          <span class="logo-text">ResuMate</span>
        </a>

        <div class="navbar-right">
          <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Home</a>
            <a href="upload.html" class="nav-link active">Internships</a>
            <a href="/interview" class="nav-link">Interview</a>
            <a href="/ats" class="nav-link">ATS Score</a>
            <a href="/history" class="nav-link">History</a>
            <a href="/settings" class="nav-link">Settings</a>
          </div>
          <div class="nav-divider"></div>

          <div class="profile-section">
            <a href="/profile" class="profile-link">
              <img src="https://i.pravatar.cc/40" alt="Profile" class="profile-avatar">
              <span>Profile</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <section class="hero">
        <h1>Unlock Your Next Opportunity</h1>
        <p>Upload your resume to instantly discover internships perfectly matched to your skills and experience. Let our AI do the searching for you.</p>
      </section>

      <section class="upload-section">
        <form id="uploadForm" enctype="multipart/form-data">
          <label for="resumeFile" class="custom-file-label" id="customFileLabel">
            üìÑ Choose PDF Resume
          </label>
          <input type="file" id="resumeFile" name="resume" accept=".pdf" required hidden />
          <button type="submit" class="cta-button">Analyze & Find Internships</button>
        </form>
        <div id="loadingSpinner" class="spinner" style="display: none;"></div>
        <p id="uploadingMessage" class="upload-message" style="display: none;">Analyzing your resume and finding matches...</p>

        <div id="uploadErrorDisplay" class="upload-error-message" style="display: none;">
            </div>
      </section>

      <div class="right-panel" id="rightPanel" style="display: none;">
    
        <div class="filter-toggle-container">
            <button class="filter-toggle-btn" id="filterToggleBtn">
                <span id="filter-icon">‚öôÔ∏è</span> Show Filters
            </button>
        </div>
        
        <div class="filter-controls-wrapper" id="filterControlsWrapper">
            <div class="filter-controls">
                <h3>Filter Internships</h3>
                <div class="filter-group">
                    <label for="locationFilter">Location:</label>
                    <select id="locationFilter">
                        <option value="">All Locations</option>
                    </select>
                </div>
    
                <div class="filter-group">
                    <label for="minStipend">Min. Stipend (‚Çπ):</label>
                    <input type="number" id="minStipend" min="0" placeholder="e.g., 10000">
                </div>
    
                <div class="filter-group">
                    <label for="minAts">Min. ATS Match (%):</label>
                    <input type="number" id="minAts" min="0" max="100" placeholder="e.g., 50">
                </div>
    
                <div class="filter-buttons">
                    <button id="applyFiltersBtn" class="cta-button">Apply</button>
                    <button id="resetFiltersBtn" class="cta-button secondary">Reset</button>
                </div>
            </div>
        </div>
    
        <div id="internshipResults"></div>
    </div>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let allInternships = [];

      const fileInput = document.getElementById("resumeFile");
      const customLabel = document.getElementById("customFileLabel");
      const uploadForm = document.getElementById("uploadForm");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const uploadingMessage = document.getElementById("uploadingMessage");
      const internshipResults = document.getElementById("internshipResults");
      const rightPanel = document.getElementById("rightPanel");
      const uploadErrorDisplay = document.getElementById('uploadErrorDisplay');
      const filterToggleBtn = document.getElementById('filterToggleBtn');
      const filterControlsWrapper = document.getElementById('filterControlsWrapper');
      const filterIcon = document.getElementById('filter-icon');
      const locationFilter = document.getElementById('locationFilter');
      const minStipendInput = document.getElementById('minStipend');
      const minAtsInput = document.getElementById('minAts');
      const applyFiltersBtn = document.getElementById('applyFiltersBtn');
      const resetFiltersBtn = document.getElementById('resetFiltersBtn');
      
      rightPanel.style.display = 'none';

      if (fileInput) {
        fileInput.addEventListener("change", () => {
          const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : "üìÑ Choose PDF Resume";
          customLabel.textContent = `üìé ${fileName}`;
        });
      }

      uploadForm?.addEventListener("submit", async function (e) {
        e.preventDefault();
        const file = fileInput.files[0];
        if (!file) {
          alert("Please upload a resume file (PDF).");
          return;
        }

        loadingSpinner.style.display = "block";
        uploadingMessage.style.display = "block";
        rightPanel.style.display = 'none';
        internshipResults.innerHTML = "";
        filterControlsWrapper.classList.remove('show-filters');
        filterIcon.textContent = '‚öôÔ∏è';
        filterToggleBtn.textContent = 'Show Filters';
        filterToggleBtn.prepend(filterIcon);
        
        uploadErrorDisplay.style.display = 'none';
        uploadErrorDisplay.innerText = '';

        const formData = new FormData();
        formData.append("resume", file);

        try {
          const res = await fetch(`https://resumate-ewtu.onrender.com/api/upload`, {
            method: "POST",
            body: formData
          });

          if (!res.ok) {
            const rawErrorText = await res.text();
            let errorData = {};
            try {
              errorData = JSON.parse(rawErrorText);
            } catch (parseError) {
              errorData = { message: rawErrorText || res.statusText };
            }

            if (res.status === 429) {
              uploadErrorDisplay.innerText = "‚ö†Ô∏è AI assistant is currently unavailable due to quota limits. Please try again later.";
            } else {
              uploadErrorDisplay.innerText = `‚ùå Error processing resume: ${errorData.message || "Unknown error."}`;
            }
            uploadErrorDisplay.style.display = 'block';
            
            loadingSpinner.style.display = "none";
            uploadingMessage.style.display = "none";
            rightPanel.style.display = 'block';
            internshipResults.innerHTML = "";

            return;
          }

          const data = await res.json();
          loadingSpinner.style.display = "none";
          uploadingMessage.style.display = "none";

          if (data.internships && data.internships.length > 0) {
            allInternships = data.internships;
            renderInternships(allInternships);
            rightPanel.style.display = 'block';
            populateLocationFilter();
          } else {
            internshipResults.innerHTML = '<p class="no-results-message">No internships found matching your resume.</p>';
            rightPanel.style.display = 'block';
          }

        } catch (err) {
          console.error("‚ùå Upload failed:", err);
          loadingSpinner.style.display = "none";
          uploadingMessage.style.display = "none";
          rightPanel.style.display = 'block';

          uploadErrorDisplay.innerText = "‚ùå Network error or unexpected issue. Please check your connection or try again.";
          uploadErrorDisplay.style.display = 'block';
          internshipResults.innerHTML = "";
        }
      });

      filterToggleBtn.addEventListener('click', function () {
        filterControlsWrapper.classList.toggle('show-filters');
        if (filterControlsWrapper.classList.contains('show-filters')) {
          filterIcon.textContent = 'üîº';
          filterToggleBtn.textContent = 'Hide Filters';
          filterToggleBtn.prepend(filterIcon);
        } else {
          filterIcon.textContent = '‚öôÔ∏è';
          filterToggleBtn.textContent = 'Show Filters';
          filterToggleBtn.prepend(filterIcon);
        }
      });

      function renderInternships(internshipsToRender) {
        internshipResults.innerHTML = "<h3>Internship Matches</h3>";
      
        if (!internshipsToRender || internshipsToRender.length === 0) {
          internshipResults.innerHTML += '<p class="no-results-message">No results found for the selected filters.</p>';
          return;
        }
      
        internshipsToRender.forEach(job => {
          const matchDiv = document.createElement("div");
          matchDiv.className = "card";
      
          const atsScore = job.ats !== 'N/A' ? parseInt(job.ats) : 0;
          let atsSpanClass = 'ats-none';
      
          if (atsScore >= 80) {
            atsSpanClass = 'ats-high';
            matchDiv.classList.add('card-ats-high');
          } else if (atsScore >= 45) {
            atsSpanClass = 'ats-medium';
            matchDiv.classList.add('card-ats-medium');
          } else {
            atsSpanClass = 'ats-low';
            matchDiv.classList.add('card-ats-low');
          }
      
          matchDiv.innerHTML = `
            <h4>${job.title}</h4>
            <p><strong>Company:</strong> ${job.company || 'N/A'}</p>
            <p><strong>üìç Location:</strong> ${job.location}</p>
            <p><strong>üí∞ Stipend:</strong> ${job.stipend}</p>
            <p><strong>üìä ATS Match:</strong> <span class="${atsSpanClass}">${job.ats}%</span></p>
            <div class="card-links">
                <a href="${job.link}" target="_blank" class="card-link">View Internship</a>
                <a href="${job.apply}" target="_blank" class="card-link apply">Apply Now</a>
            </div>
            <button class="track-btn" data-title="${job.title}" data-company="${job.company}" data-link="${job.link}" data-ats="${job.ats}">üìå Track this</button>
          `;
      
          internshipResults.appendChild(matchDiv);
      
          const trackBtn = matchDiv.querySelector(".track-btn");
          trackBtn.addEventListener("click", async function () {
            const internshipData = {
              title: this.dataset.title,
              company: this.dataset.company,
              link: this.dataset.link,
              ats: this.dataset.ats,
              userId: localStorage.getItem("userId") || ""
            };
      
            try {
              const response = await fetch("https://resumate-ewtu.onrender.com/api/track-internship", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(internshipData)
              });
      
              if (response.ok) {
                alert("‚úÖ Internship tracked successfully!");
              } else {
                const errData = await response.json();
                alert(`‚ùå Failed to track internship: ${errData.message}`);
              }
            } catch (err) {
              console.error("Tracking Error:", err);
              alert("‚ùå Could not track the internship. Try again.");
            }
          });
        });
      }

      function populateLocationFilter() {
        locationFilter.innerHTML = '<option value="">All Locations</option>';
        const uniqueLocations = [...new Set(allInternships.map(job => job.location).filter(Boolean))].sort();
        uniqueLocations.forEach(location => {
          const option = document.createElement('option');
          option.value = location;
          option.textContent = location;
          locationFilter.appendChild(option);
        });
      }

      applyFiltersBtn.addEventListener('click', applyFilters);
      resetFiltersBtn.addEventListener('click', resetFilters);

      function applyFilters() {
        const locationValue = locationFilter.value.toLowerCase();
        const minStipend = parseInt(minStipendInput.value) || 0;
        const minATS = parseInt(minAtsInput.value) || 0;

        const filteredInternships = allInternships.filter(job => {
          const jobLocation = job.location ? job.location.toLowerCase() : '';
          const jobStipendMatch = job.stipend ? job.stipend.match(/[\d,]+/) : null;
          const jobStipend = jobStipendMatch ? parseInt(jobStipendMatch[0].replace(/,/g, '')) : 0;
          const jobATS = job.ats !== 'N/A' ? parseInt(job.ats) : 0;

          const matchLocation = !locationValue || jobLocation.includes(locationValue);
          const matchStipend = jobStipend >= minStipend;
          const matchATS = jobATS >= minATS;
          
          return matchLocation && matchStipend && matchATS;
        });

        renderInternships(filteredInternships);
      }

      function resetFilters() {
        locationFilter.value = '';
        minStipendInput.value = '';
        minAtsInput.value = '';
        renderInternships(allInternships);
      }
    });
  </script>

</body>
</html>